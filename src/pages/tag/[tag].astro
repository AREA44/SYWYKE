---
import BaseLayout from '@/layouts/BaseLayout.astro'
import OutlineHeading from '@/components/OutlineHeading.astro'
import ListItem from '@/components/ListItem.astro'
import {
  Card,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'

import { getCollection } from 'astro:content'
import { sitesAndTags } from '@/utils/sites'

const tags = await getCollection('sites')
const { allTags } = sitesAndTags(tags)
const tagsSorted = allTags ? Object.keys(allTags).sort() : []

export async function getStaticPaths() {
  const sites = await getCollection('sites')
  const { allTags } = sitesAndTags(sites)
  return Object.keys(allTags).map((tag) => ({
    params: { tag: tag },
    props: { sites: allTags[tag] },
  }))
}

const { tag } = Astro.params
const { sites } = Astro.props

let tagHeader = `${sites.length} site${
  sites.length === 1 ? '' : 's'
} tagged with "${tag}"`
let title = `${tagHeader} | Sites You Wish You Know Earlier!`
let description = tagHeader
---

<BaseLayout title={title} description={description}>
    <h2
      class="scroll-m-20 border-b pb-2 text-3xl font-semibold tracking-tight transition-colors first:mt-0"
    >
      Browse Sites by Tag
    </h2>
    <div class="p-2">
    {
      tagsSorted.map((tag) => (
        <Badge>
          <a href={`/tag/${tag}/`}>
            {tag} | {allTags[tag].length}
          </a>
        </Badge>
      ))
    }
  </div>
  <h2 class="scroll-m-20 border-b pb-2 text-3xl font-semibold tracking-tight transition-colors first:mt-0">
    {tagHeader}
  </h2>
  <div>
    {
      sites.map(({ url, data: { description, site, title, tags } }) => (
        <Card>
          <a href={site} target="_blank">
            <CardHeader>
              <CardTitle>{title}</CardTitle>
              <CardDescription>{description}</CardDescription>
            </CardHeader>
            <CardFooter>
              {tags.map((tag) => (
                <Badge>
                  <a href={`/tag/${tag}/`}>{tag}</a>
                </Badge>
              ))}
            </CardFooter>
          </a>
        </Card>
      ))
    }
  </div>
</BaseLayout>
